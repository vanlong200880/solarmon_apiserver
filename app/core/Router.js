"use strict";

var _EmployeeService = require("../services/EmployeeService");

var _EmployeeService2 = _interopRequireDefault(_EmployeeService);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var url = require("url");
var querystring = require("querystring");
var fs = require('fs');
var getProtocol = function getProtocol(req) {
	var proto = req.connection.encrypted ? 'https' : 'http';
	proto = req.headers['x-forwarded-proto'] || proto;
	return proto.split(/\s*,\s*/)[0];
};

function route(req, resp) {

	i18n.setLocale(config.i18n.defaultLocale);
	var curUrl = url.parse(req.url);
	var pathname = curUrl.pathname.replace(config.server.context_path + "/", "");

	var public_path_idx = config.server.public_path.indexOf(pathname);
	var query = curUrl.query;
	var protocol = getProtocol(req);
	var pathSplit = pathname.split("/");
	var host = Libs.toLowerCase(req.hostname);
	if (req.headers.origin) {
		host = req.headers.origin.replace(/(^\w+:|^)\/\//, '');
	}
	host = host.replace(/[:]{1}\d*/, '');
	var hostPartLength = (host.match(/\./g) || []).length;
	var referDomain = host;
	if (hostPartLength >= 2) {
		referDomain = host.replace(new RegExp('^[a-z0-9]*\.'), '');
	}
	/** check domain cho phep truy cap*/
	if (public_path_idx < 0 && (!config.server.domain || config.server.domain.indexOf(referDomain) < 0) && req.hostname != host) {
		resp.status(401).send(Libs.returnJsonResult(false, i18n.__('AUTH_FALSE'), {}, 0));
		return;
	}

	var splitHost = host.match(new RegExp('^[a-z0-9]*\.'));
	if (!splitHost || splitHost.length < 0) {
		resp.status(401).send(Libs.returnJsonResult(false, i18n.__('AUTH_FALSE'), {}, 0));
		return;
	}
	var subHost = splitHost[0].replace('.', '');
	if (Libs.isBlank(pathSplit[1])) {
		// pathSplit[1] = defaultController;
		log.info("No request function found for " + method);
		resp.writeHead(404, {
			"Content-Type": "text/plain"
		});
		resp.write("404 request handler Not found");
		resp.end();
		return;
	}

	var handleRequest = function handleRequest(req, resp, handle, method) {
		try {
			if (typeof handle[method] === 'function') {
				var postData = "";
				req.addListener("data", function (postDataChunk) {
					postData += postDataChunk;
				});
				req.addListener("end", async function () {
					var data = {};
					var isJson = true;
					try {
						data = JSON.parse(postData);
					} catch (e) {
						isJson = false;
						log.error(e);
					}

					if (!isJson) {
						if (!Libs.isBlank(query)) {
							postData = query + "&" + postData;
						}
						data = querystring.parse(postData);
					}
					var token = req.headers['x-access-token'];
					var userE = Libs.decodeTokenCrypto(token);
					if (null != userE) {
						try {
							var employee = new _EmployeeService2.default();
							userE.permissions = await employee.getCachePermission(userE);

							var expiresTime = userE['expiresTime'];
							var now = new Date().getTime();
							if (now > expiresTime) {
								resp.writeHead(401, {
									"Content-Type": "text/plain"
								});
								resp.end();
							}
							handle.userE = userE;
							data.currentUser = userE.email;
						} catch (e) {
							console.log(e);
						}
					}
					handle.headers = req.headers;
					handle.baseUrl = protocol + "://" + req.headers.host;
					if (config.server.context_path) {
						handle.baseUrl += "/" + config.server.context_path;
					}

					data.action = method;
					data.lang = i18n.getLocale();
					data.lang_default = i18n.getLocale();
					if (typeof req.headers.lang != 'undefined' && req.headers.lang != '') {
						data.lang = req.headers.lang;
						i18n.setLocale(req.headers.lang);
					}

					if (!Libs.isInArray(pathname, Constants.public_api) && public_path_idx < 0) {
						// if(pathname !== Constants.public_api.login && public_path_idx < 0){
						// let pathReferer = route.checkPathReferer(req);

						// handle.pathReferer = pathReferer;


						// if(!pathReferer){
						// 	// console.log("thêm 'req_path' vào header");
						// 	resp.status(511).send(Libs.returnJsonResult(false, i18n.__('AUTH_REQUIRE'), {}, 0));
						// 	return;
						// }
						// if(typeof handle['checkPermission'] === 'function'){
						// 	let auth = handle['checkPermission'](Constants.auth_mode.VIEW);
						// 	if(!auth){
						// 		resp.status(401).send(Libs.returnJsonResult(false, i18n.__('AUTH_FALSE'), {}, 0));
						// 		return;
						// 	}
						// }
						// if(typeof handle['checkPermissions'] === 'function'){
						// 	let auth = handle['checkPermissions'](method, data);
						// 	if(!auth){
						// 		resp.send(Libs.returnJsonResult(false, i18n.__('AUTH_FALSE'), {}, 0));
						// 		return;
						// 	}
						// } 
					}
					if (userE) {
						var logE = Object.assign({}, data);
						logE.key = userE.email;
						logE.event_time = Libs.getCurrentDateFormat('yyyyMMddHHmmss');
						event.emit('log', Constants.type_log.request, { table_name: null, content: logE });
					}
					handle[method](resp, data);
				});
			} else {
				log.info("No request function found for " + method);
				resp.writeHead(404, {
					"Content-Type": "text/plain"
				});
				resp.write("404 request handler Not found");
				resp.end();
			}
		} catch (e) {
			console.log(e);
		}
	};
	var controller = Libs.capitalize(pathSplit[1]) + "Controller";
	var handle = null;
	if (Libs.checkFileExits(controlPath, controller + '.js')) {

		var cls = require(controlPath + controller);
		handle = new cls['default']();
		if (Libs.isBlank(pathSplit[2])) {
			// pathSplit[2] = defaultFunction;
			log.info("No request function found for " + method);
			resp.writeHead(404, {
				"Content-Type": "text/plain"
			});
			resp.write("404 request handler Not found");
			resp.end();
			return;
		}
		var method = pathSplit[2];
		handleRequest(req, resp, handle, method);
	} else {
		var rQCtrName = controller.toLowerCase() + '.js';
		var files = fs.readdirSync(controlPath);
		var controllerNew = null;
		files.forEach(function (file) {
			var lowerFileName = file.toLowerCase();
			if (lowerFileName === rQCtrName) {
				controllerNew = file;
				return true;
			}
		});
		if (controllerNew != null) {
			var cls = require(controlPath + controllerNew);
			handle = new cls['default']();
			if (Libs.isBlank(pathSplit[2])) {
				// pathSplit[2] = defaultFunction;
				log.info("No request function found for " + method);
				resp.writeHead(404, {
					"Content-Type": "text/plain"
				});
				resp.write("404 request handler Not found");
				resp.end();
				return;
			}
			var method = pathSplit[2];
			// var method = action;
			handleRequest(req, resp, handle, method);
		} else {
			log.info("No request file found for " + pathname);
			resp.writeHead(404, {
				"Content-Type": "text/plain"
			});
			resp.write("404 request handler Not found");
			resp.end();
		}
	}
}

route.checkPathReferer = function (req) {
	try {
		var req_path = req.headers['req-path'];
		var referer = false;
		var pathReferer = false;
		if (req_path) {
			referer = req_path;
		} else {
			referer = req.headers.referer;
		}
		if (referer) {
			pathReferer = url.parse(referer, false).pathname;
		}
		return pathReferer;
	} catch (ex) {
		console.log("checkPathReferer error:", ex);
		return null;
	}
};
exports.route = route;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb3JlL1JvdXRlci5qcyJdLCJuYW1lcyI6WyJ1cmwiLCJyZXF1aXJlIiwicXVlcnlzdHJpbmciLCJmcyIsImdldFByb3RvY29sIiwicmVxIiwicHJvdG8iLCJjb25uZWN0aW9uIiwiZW5jcnlwdGVkIiwiaGVhZGVycyIsInNwbGl0Iiwicm91dGUiLCJyZXNwIiwiaTE4biIsInNldExvY2FsZSIsImNvbmZpZyIsImRlZmF1bHRMb2NhbGUiLCJjdXJVcmwiLCJwYXJzZSIsInBhdGhuYW1lIiwicmVwbGFjZSIsInNlcnZlciIsImNvbnRleHRfcGF0aCIsInB1YmxpY19wYXRoX2lkeCIsInB1YmxpY19wYXRoIiwiaW5kZXhPZiIsInF1ZXJ5IiwicHJvdG9jb2wiLCJwYXRoU3BsaXQiLCJob3N0IiwiTGlicyIsInRvTG93ZXJDYXNlIiwiaG9zdG5hbWUiLCJvcmlnaW4iLCJob3N0UGFydExlbmd0aCIsIm1hdGNoIiwibGVuZ3RoIiwicmVmZXJEb21haW4iLCJSZWdFeHAiLCJkb21haW4iLCJzdGF0dXMiLCJzZW5kIiwicmV0dXJuSnNvblJlc3VsdCIsIl9fIiwic3BsaXRIb3N0Iiwic3ViSG9zdCIsImlzQmxhbmsiLCJsb2ciLCJpbmZvIiwibWV0aG9kIiwid3JpdGVIZWFkIiwid3JpdGUiLCJlbmQiLCJoYW5kbGVSZXF1ZXN0IiwiaGFuZGxlIiwicG9zdERhdGEiLCJhZGRMaXN0ZW5lciIsInBvc3REYXRhQ2h1bmsiLCJkYXRhIiwiaXNKc29uIiwiSlNPTiIsImUiLCJlcnJvciIsInRva2VuIiwidXNlckUiLCJkZWNvZGVUb2tlbkNyeXB0byIsImVtcGxveWVlIiwiRW1wbG95ZWVTZXJ2aWNlIiwicGVybWlzc2lvbnMiLCJnZXRDYWNoZVBlcm1pc3Npb24iLCJleHBpcmVzVGltZSIsIm5vdyIsIkRhdGUiLCJnZXRUaW1lIiwiY3VycmVudFVzZXIiLCJlbWFpbCIsImNvbnNvbGUiLCJiYXNlVXJsIiwiYWN0aW9uIiwibGFuZyIsImdldExvY2FsZSIsImxhbmdfZGVmYXVsdCIsImlzSW5BcnJheSIsIkNvbnN0YW50cyIsInB1YmxpY19hcGkiLCJsb2dFIiwiT2JqZWN0IiwiYXNzaWduIiwia2V5IiwiZXZlbnRfdGltZSIsImdldEN1cnJlbnREYXRlRm9ybWF0IiwiZXZlbnQiLCJlbWl0IiwidHlwZV9sb2ciLCJyZXF1ZXN0IiwidGFibGVfbmFtZSIsImNvbnRlbnQiLCJjb250cm9sbGVyIiwiY2FwaXRhbGl6ZSIsImNoZWNrRmlsZUV4aXRzIiwiY29udHJvbFBhdGgiLCJjbHMiLCJyUUN0ck5hbWUiLCJmaWxlcyIsInJlYWRkaXJTeW5jIiwiY29udHJvbGxlck5ldyIsImZvckVhY2giLCJsb3dlckZpbGVOYW1lIiwiZmlsZSIsImNoZWNrUGF0aFJlZmVyZXIiLCJyZXFfcGF0aCIsInJlZmVyZXIiLCJwYXRoUmVmZXJlciIsImV4IiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFRQTs7Ozs7O0FBUkEsSUFBSUEsTUFBTUMsUUFBUSxLQUFSLENBQVY7QUFDQSxJQUFJQyxjQUFjRCxRQUFRLGFBQVIsQ0FBbEI7QUFDQSxJQUFJRSxLQUFLRixRQUFRLElBQVIsQ0FBVDtBQUNBLElBQU1HLGNBQWMsU0FBZEEsV0FBYyxDQUFVQyxHQUFWLEVBQWU7QUFDbEMsS0FBSUMsUUFBUUQsSUFBSUUsVUFBSixDQUFlQyxTQUFmLEdBQTJCLE9BQTNCLEdBQXFDLE1BQWpEO0FBQ0FGLFNBQVFELElBQUlJLE9BQUosQ0FBWSxtQkFBWixLQUFvQ0gsS0FBNUM7QUFDQSxRQUFPQSxNQUFNSSxLQUFOLENBQVksU0FBWixFQUF1QixDQUF2QixDQUFQO0FBQ0EsQ0FKRDs7QUFNQSxTQUFTQyxLQUFULENBQWVOLEdBQWYsRUFBb0JPLElBQXBCLEVBQTBCOztBQUV6QkMsTUFBS0MsU0FBTCxDQUFlQyxPQUFPRixJQUFQLENBQVlHLGFBQTNCO0FBQ0EsS0FBSUMsU0FBU2pCLElBQUlrQixLQUFKLENBQVViLElBQUlMLEdBQWQsQ0FBYjtBQUNBLEtBQUltQixXQUFXRixPQUFP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QUFDQVAsUUFBS3NDLFNBQUwsQ0FBZSxHQUFmLEVBQW9CO0FBQ25CLG9CQUFnQjtBQURHLElBQXBCO0FBR0F0QyxRQUFLdUMsS0FBTCxDQUFXLCtCQUFYO0FBQ0F2QyxRQUFLd0MsR0FBTDtBQUNBO0FBQ0Q7QUFDRDs7QUFFRHpDLE1BQU1rRyxnQkFBTixHQUF5QixVQUFDeEcsR0FBRCxFQUFRO0FBQ2hDLEtBQUc7QUFDRixNQUFJeUcsV0FBV3pHLElBQUlJLE9BQUosQ0FBWSxVQUFaLENBQWY7QUFDQSxNQUFJc0csVUFBVSxLQUFkO0FBQ0EsTUFBSUMsY0FBYyxLQUFsQjtBQUNBLE1BQUdGLFFBQUgsRUFBWTtBQUNYQyxhQUFVRCxRQUFWO0FBQ0EsR0FGRCxNQUVLO0FBQ0pDLGFBQVUxRyxJQUFJSSxPQUFKLENBQVlzRyxPQUF0QjtBQUNBO0FBQ0QsTUFBR0EsT0FBSCxFQUFXO0FBQ1ZDLGlCQUFjaEgsSUFBSWtCLEtBQUosQ0FBVTZGLE9BQVYsRUFBbUIsS0FBbkIsRUFBMEI1RixRQUF4QztBQUNBO0FBQ0QsU0FBTzZGLFdBQVA7QUFDQSxFQWJELENBYUMsT0FBTUMsRUFBTixFQUFTO0FBQ1RyQyxVQUFRN0IsR0FBUixDQUFZLHlCQUFaLEVBQXVDa0UsRUFBdkM7QUFDQSxTQUFPLElBQVA7QUFDQTtBQUVELENBbkJEO0FBb0JBQyxRQUFRdkcsS0FBUixHQUFnQkEsS0FBaEIiLCJmaWxlIjoiUm91dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIHVybCA9IHJlcXVpcmUoXCJ1cmxcIik7XG52YXIgcXVlcnlzdHJpbmcgPSByZXF1aXJlKFwicXVlcnlzdHJpbmdcIik7XG52YXIgZnMgPSByZXF1aXJlKCdmcycpO1xuY29uc3QgZ2V0UHJvdG9jb2wgPSBmdW5jdGlvbiAocmVxKSB7XG5cdHZhciBwcm90byA9IHJlcS5jb25uZWN0aW9uLmVuY3J5cHRlZCA/ICdodHRwcycgOiAnaHR0cCc7XG5cdHByb3RvID0gcmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLXByb3RvJ10gfHwgcHJvdG87XG5cdHJldHVybiBwcm90by5zcGxpdCgvXFxzKixcXHMqLylbMF07XG59XG5pbXBvcnQgRW1wbG95ZWVTZXJ2aWNlIGZyb20gJy4uL3NlcnZpY2VzL0VtcGxveWVlU2VydmljZSc7XG5mdW5jdGlvbiByb3V0ZShyZXEsIHJlc3ApIHtcblxuXHRpMThuLnNldExvY2FsZShjb25maWcuaTE4bi5kZWZhdWx0TG9jYWxlKTtcblx0dmFyIGN1clVybCA9IHVybC5wYXJzZShyZXEudXJsKTtcblx0dmFyIHBhdGhuYW1lID0gY3VyVXJsLnBhdGhuYW1lLnJlcGxhY2UoY29uZmlnLnNlcnZlci5jb250ZXh0X3BhdGgrXCIvXCIsXCJcIik7XG5cblx0bGV0IHB1YmxpY19wYXRoX2lkeCA9IGNvbmZpZy5zZXJ2ZXIucHVibGljX3BhdGguaW5kZXhPZihwYXRobmFtZSk7XG5cdHZhciBxdWVyeSA9IGN1clVybC5xdWVyeTtcblx0dmFyIHByb3RvY29sID0gZ2V0UHJvdG9jb2wocmVxKVxuXHR2YXIgcGF0aFNwbGl0ID0gcGF0aG5hbWUuc3BsaXQoXCIvXCIpO1xuXHRsZXQgaG9zdCA9IExpYnMudG9Mb3dlckNhc2UocmVxLmhvc3RuYW1lKTtcblx0aWYocmVxLmhlYWRlcnMub3JpZ2luKXtcblx0XHRob3N0ID0gcmVxLmhlYWRlcnMub3JpZ2luLnJlcGxhY2UoLyheXFx3Kzp8XilcXC9cXC8vLCAnJyk7XG5cdH1cblx0aG9zdCA9IGhvc3QucmVwbGFjZSgvWzpdezF9XFxkKi8sJycpO1xuXHRsZXQgaG9zdFBhcnRMZW5ndGggPSAoaG9zdC5tYXRjaCgvXFwuL2cpIHx8IFtdKS5sZW5ndGg7XG5cdGxldCByZWZlckRvbWFpbiA9IGhvc3Q7XG5cdGlmKGhvc3RQYXJ0TGVuZ3RoPj0yKXtcblx0XHRyZWZlckRvbWFpbiA9IGhvc3QucmVwbGFjZShuZXcgUmVnRXhwKCdeW2EtejAtOV0qXFwuJyksJycpO1xuXHR9XG5cdC8qKiBjaGVjayBkb21haW4gY2hvIHBoZXAgdHJ1eSBjYXAqL1xuXHRpZihwdWJsaWNfcGF0aF9pZHg8MCAmJiAoICFjb25maWcuc2VydmVyLmRvbWFpbiB8fCBjb25maWcuc2VydmVyLmRvbWFpbi5pbmRleE9mKHJlZmVyRG9tYWluKTwwKSAmJiAocmVxLmhvc3RuYW1lICE9IGhvc3QpKXtcblx0XHRyZXNwLnN0YXR1cyg0MDEpLnNlbmQoTGlicy5yZXR1cm5Kc29uUmVzdWx0KGZhbHNlLCBpMThuLl9fKCdBVVRIX0ZBTFNFJyksIHt9LCAwKSk7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0bGV0IHNwbGl0SG9zdCA9IGhvc3QubWF0Y2gobmV3IFJlZ0V4cCgnXlthLXowLTldKlxcLicpKTtcblx0aWYoIXNwbGl0SG9zdCB8fCBzcGxpdEhvc3QubGVuZ3RoIDwwKXtcblx0XHRyZXNwLnN0YXR1cyg0MDEpLnNlbmQoTGlicy5yZXR1cm5Kc29uUmVzdWx0KGZhbHNlLCBpMThuLl9fKCdBVVRIX0ZBTFNFJyksIHt9LCAwKSk7XG5cdFx0cmV0dXJuO1xuXHR9XG5cdGxldCBzdWJIb3N0ID0gc3BsaXRIb3N0WzBdLnJlcGxhY2UoJy4nLCAnJykgO1xuXHRpZiAoTGlicy5pc0JsYW5rKHBhdGhTcGxpdFsxXSkpIHtcblx0XHQvLyBwYXRoU3BsaXRbMV0gPSBkZWZhdWx0Q29udHJvbGxlcjtcblx0XHRsb2cuaW5mbyhcIk5vIHJlcXVlc3QgZnVuY3Rpb24gZm91bmQgZm9yIFwiICsgbWV0aG9kKTtcblx0XHRyZXNwLndyaXRlSGVhZCg0MDQsIHtcblx0XHRcdFwiQ29udGVudC1UeXBlXCI6IFwidGV4dC9wbGFpblwiXG5cdFx0fSk7XG5cdFx0cmVzcC53cml0ZShcIjQwNCByZXF1ZXN0IGhhbmRsZXIgTm90IGZvdW5kXCIpO1xuXHRcdHJlc3AuZW5kKCk7XG5cdFx0cmV0dXJuO1xuXHR9XG5cdFxuXG5cdHZhciBoYW5kbGVSZXF1ZXN0ID0gZnVuY3Rpb24gKHJlcSwgcmVzcCwgaGFuZGxlLCBtZXRob2QpIHtcblx0XHR0cnkge1xuXHRcdFx0aWYgKHR5cGVvZiBoYW5kbGVbbWV0aG9kXSA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0XHR2YXIgcG9zdERhdGEgPSBcIlwiO1xuXHRcdFx0XHRyZXEuYWRkTGlzdGVuZXIoXCJkYXRhXCIsIGZ1bmN0aW9uIChwb3N0RGF0YUNodW5rKSB7XG5cdFx0XHRcdFx0cG9zdERhdGEgKz0gcG9zdERhdGFDaHVuaztcblx0XHRcdFx0fSk7XG5cdFx0XHRcdHJlcS5hZGRMaXN0ZW5lcihcImVuZFwiLCBhc3luYyBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdFx0dmFyIGRhdGEgPSB7fTtcblx0XHRcdFx0XHR2YXIgaXNKc29uID0gdHJ1ZTtcblx0XHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdFx0ZGF0YSA9IEpTT04ucGFyc2UocG9zdERhdGEpO1xuXHRcdFx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0XHRcdGlzSnNvbiA9IGZhbHNlO1xuXHRcdFx0XHRcdFx0bG9nLmVycm9yKGUpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGlmICghaXNKc29uKSB7XG5cdFx0XHRcdFx0XHRpZiAoIUxpYnMuaXNCbGFuayhxdWVyeSkpIHtcblx0XHRcdFx0XHRcdFx0cG9zdERhdGEgPSBxdWVyeSArIFwiJlwiICsgcG9zdERhdGE7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRkYXRhID0gcXVlcnlzdHJpbmcucGFyc2UocG9zdERhdGEpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRsZXQgdG9rZW4gPSByZXEuaGVhZGVyc1sneC1hY2Nlc3MtdG9rZW4nXTtcblx0XHRcdFx0XHRsZXQgdXNlckUgPSBMaWJzLmRlY29kZVRva2VuQ3J5cHRvKHRva2VuKTtcblx0XHRcdFx0XHRpZiAobnVsbCAhPSB1c2VyRSkge1xuXHRcdFx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRcdFx0bGV0IGVtcGxveWVlID0gbmV3IEVtcGxveWVlU2VydmljZSgpO1xuXHRcdFx0XHRcdFx0XHR1c2VyRS5wZXJtaXNzaW9ucyA9IGF3YWl0IGVtcGxveWVlLmdldENhY2hlUGVybWlzc2lvbih1c2VyRSk7XG5cblx0XHRcdFx0XHRcdFx0bGV0IGV4cGlyZXNUaW1lID0gdXNlckVbJ2V4cGlyZXNUaW1lJ107XG5cdFx0XHRcdFx0XHRcdGxldCBub3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcblx0XHRcdFx0XHRcdFx0aWYgKG5vdyA+IGV4cGlyZXNUaW1lKSB7XG5cdFx0XHRcdFx0XHRcdFx0cmVzcC53cml0ZUhlYWQoNDAxLCB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcIkNvbnRlbnQtVHlwZVwiOiBcInRleHQvcGxhaW5cIlxuXHRcdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0XHRcdHJlc3AuZW5kKCk7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0aGFuZGxlLnVzZXJFID0gdXNlckU7XG5cdFx0XHRcdFx0XHRcdGRhdGEuY3VycmVudFVzZXIgPSB1c2VyRS5lbWFpbDtcblx0XHRcdFx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0XHRcdFx0Y29uc29sZS5sb2coZSlcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0aGFuZGxlLmhlYWRlcnMgPSByZXEuaGVhZGVycztcblx0XHRcdFx0XHRoYW5kbGUuYmFzZVVybCA9IHByb3RvY29sK1wiOi8vXCIgKyByZXEuaGVhZGVycy5ob3N0O1xuXHRcdFx0XHRcdGlmKGNvbmZpZy5zZXJ2ZXIuY29udGV4dF9wYXRoKXtcblx0XHRcdFx0XHRcdGhhbmRsZS5iYXNlVXJsKz1gLyR7Y29uZmlnLnNlcnZlci5jb250ZXh0X3BhdGh9YDtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRkYXRhLmFjdGlvbiA9IG1ldGhvZDtcblx0XHRcdFx0XHRkYXRhLmxhbmcgPSBpMThuLmdldExvY2FsZSgpO1xuXHRcdFx0XHRcdGRhdGEubGFuZ19kZWZhdWx0ID0gaTE4bi5nZXRMb2NhbGUoKTtcblx0XHRcdFx0XHRpZiAodHlwZW9mIHJlcS5oZWFkZXJzLmxhbmcgIT0gJ3VuZGVmaW5lZCcgJiYgcmVxLmhlYWRlcnMubGFuZyAhPSAnJykge1xuXHRcdFx0XHRcdFx0ZGF0YS5sYW5nID0gcmVxLmhlYWRlcnMubGFuZztcblx0XHRcdFx0XHRcdGkxOG4uc2V0TG9jYWxlKHJlcS5oZWFkZXJzLmxhbmcpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcblx0XHRcdFx0XHRpZighTGlicy5pc0luQXJyYXkocGF0aG5hbWUsIENvbnN0YW50cy5wdWJsaWNfYXBpKSAmJiBwdWJsaWNfcGF0aF9pZHggPCAwKXtcblx0XHRcdFx0XHQvLyBpZihwYXRobmFtZSAhPT0gQ29uc3RhbnRzLnB1YmxpY19hcGkubG9naW4gJiYgcHVibGljX3BhdGhfaWR4IDwgMCl7XG5cdFx0XHRcdFx0XHQvLyBsZXQgcGF0aFJlZmVyZXIgPSByb3V0ZS5jaGVja1BhdGhSZWZlcmVyKHJlcSk7XG5cblx0XHRcdFx0XHRcdC8vIGhhbmRsZS5wYXRoUmVmZXJlciA9IHBhdGhSZWZlcmVyO1xuXHRcdFx0XHRcdFx0XG5cblx0XHRcdFx0XHRcdC8vIGlmKCFwYXRoUmVmZXJlcil7XG5cdFx0XHRcdFx0XHQvLyBcdC8vIGNvbnNvbGUubG9nKFwidGjDqm0gJ3JlcV9wYXRoJyB2w6BvIGhlYWRlclwiKTtcblx0XHRcdFx0XHRcdC8vIFx0cmVzcC5zdGF0dXMoNTExKS5zZW5kKExpYnMucmV0dXJuSnNvblJlc3VsdChmYWxzZSwgaTE4bi5fXygnQVVUSF9SRVFVSVJFJyksIHt9LCAwKSk7XG5cdFx0XHRcdFx0XHQvLyBcdHJldHVybjtcblx0XHRcdFx0XHRcdC8vIH1cblx0XHRcdFx0XHRcdC8vIGlmKHR5cGVvZiBoYW5kbGVbJ2NoZWNrUGVybWlzc2lvbiddID09PSAnZnVuY3Rpb24nKXtcblx0XHRcdFx0XHRcdC8vIFx0bGV0IGF1dGggPSBoYW5kbGVbJ2NoZWNrUGVybWlzc2lvbiddKENvbnN0YW50cy5hdXRoX21vZGUuVklFVyk7XG5cdFx0XHRcdFx0XHQvLyBcdGlmKCFhdXRoKXtcblx0XHRcdFx0XHRcdC8vIFx0XHRyZXNwLnN0YXR1cyg0MDEpLnNlbmQoTGlicy5yZXR1cm5Kc29uUmVzdWx0KGZhbHNlLCBpMThuLl9fKCdBVVRIX0ZBTFNFJyksIHt9LCAwKSk7XG5cdFx0XHRcdFx0XHQvLyBcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFx0Ly8gXHR9XG5cdFx0XHRcdFx0XHQvLyB9XG5cdFx0XHRcdFx0XHQvLyBpZih0eXBlb2YgaGFuZGxlWydjaGVja1Blcm1pc3Npb25zJ10gPT09ICdmdW5jdGlvbicpe1xuXHRcdFx0XHRcdFx0Ly8gXHRsZXQgYXV0aCA9IGhhbmRsZVsnY2hlY2tQZXJtaXNzaW9ucyddKG1ldGhvZCwgZGF0YSk7XG5cdFx0XHRcdFx0XHQvLyBcdGlmKCFhdXRoKXtcblx0XHRcdFx0XHRcdC8vIFx0XHRyZXNwLnNlbmQoTGlicy5yZXR1cm5Kc29uUmVzdWx0KGZhbHNlLCBpMThuLl9fKCdBVVRIX0ZBTFNFJyksIHt9LCAwKSk7XG5cdFx0XHRcdFx0XHQvLyBcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFx0Ly8gXHR9XG5cdFx0XHRcdFx0XHQvLyB9IFxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRpZih1c2VyRSl7XG5cdFx0XHRcdFx0XHRsZXQgbG9nRSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSk7XG5cdFx0XHRcdFx0XHRsb2dFLmtleSA9IHVzZXJFLmVtYWlsO1xuXHRcdFx0XHRcdFx0bG9nRS5ldmVudF90aW1lID0gTGlicy5nZXRDdXJyZW50RGF0ZUZvcm1hdCgneXl5eU1NZGRISG1tc3MnKTtcblx0XHRcdFx0XHRcdGV2ZW50LmVtaXQoJ2xvZycsIENvbnN0YW50cy50eXBlX2xvZy5yZXF1ZXN0LCB7dGFibGVfbmFtZTogbnVsbCxjb250ZW50OmxvZ0V9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0aGFuZGxlW21ldGhvZF0ocmVzcCwgZGF0YSk7XG5cdFx0XHRcdH0pO1xuXG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRsb2cuaW5mbyhcIk5vIHJlcXVlc3QgZnVuY3Rpb24gZm91bmQgZm9yIFwiICsgbWV0aG9kKTtcblx0XHRcdFx0cmVzcC53cml0ZUhlYWQoNDA0LCB7XG5cdFx0XHRcdFx0XCJDb250ZW50LVR5cGVcIjogXCJ0ZXh0L3BsYWluXCJcblx0XHRcdFx0fSk7XG5cdFx0XHRcdHJlc3Aud3JpdGUoXCI0MDQgcmVxdWVzdCBoYW5kbGVyIE5vdCBmb3VuZFwiKTtcblx0XHRcdFx0cmVzcC5lbmQoKTtcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRjb25zb2xlLmxvZyhlKVxuXHRcdH1cblx0fTtcblx0dmFyIGNvbnRyb2xsZXIgPSBMaWJzLmNhcGl0YWxpemUocGF0aFNwbGl0WzFdKSArIFwiQ29udHJvbGxlclwiO1xuXHR2YXIgaGFuZGxlID0gbnVsbDtcblx0aWYgKExpYnMuY2hlY2tGaWxlRXhpdHMoY29udHJvbFBhdGgsIGNvbnRyb2xsZXIgKyAnLmpzJykpIHtcblxuXHRcdHZhciBjbHMgPSByZXF1aXJlKGNvbnRyb2xQYXRoICsgY29udHJvbGxlcik7XG5cdFx0aGFuZGxlID0gbmV3IGNsc1snZGVmYXVsdCddKCk7XG5cdFx0aWYgKExpYnMuaXNCbGFuayhwYXRoU3BsaXRbMl0pKSB7XG5cdFx0XHQvLyBwYXRoU3BsaXRbMl0gPSBkZWZhdWx0RnVuY3Rpb247XG5cdFx0XHRsb2cuaW5mbyhcIk5vIHJlcXVlc3QgZnVuY3Rpb24gZm91bmQgZm9yIFwiICsgbWV0aG9kKTtcblx0XHRcdHJlc3Aud3JpdGVIZWFkKDQwNCwge1xuXHRcdFx0XHRcIkNvbnRlbnQtVHlwZVwiOiBcInRleHQvcGxhaW5cIlxuXHRcdFx0fSk7XG5cdFx0XHRyZXNwLndyaXRlKFwiNDA0IHJlcXVlc3QgaGFuZGxlciBOb3QgZm91bmRcIik7XG5cdFx0XHRyZXNwLmVuZCgpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHR2YXIgbWV0aG9kID0gcGF0aFNwbGl0WzJdO1xuXHRcdGhhbmRsZVJlcXVlc3QocmVxLCByZXNwLCBoYW5kbGUsIG1ldGhvZCk7XG5cdH0gZWxzZSB7XG5cdFx0dmFyIHJRQ3RyTmFtZSA9IGNvbnRyb2xsZXIudG9Mb3dlckNhc2UoKSArICcuanMnO1xuXHRcdHZhciBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKGNvbnRyb2xQYXRoKTtcblx0XHR2YXIgY29udHJvbGxlck5ldyA9IG51bGw7XG5cdFx0ZmlsZXMuZm9yRWFjaChmaWxlID0+IHtcblx0XHRcdHZhciBsb3dlckZpbGVOYW1lID0gZmlsZS50b0xvd2VyQ2FzZSgpO1xuXHRcdFx0aWYgKGxvd2VyRmlsZU5hbWUgPT09IHJRQ3RyTmFtZSkge1xuXHRcdFx0XHRjb250cm9sbGVyTmV3ID0gZmlsZTtcblx0XHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdFx0aWYgKGNvbnRyb2xsZXJOZXcgIT0gbnVsbCkge1xuXHRcdFx0dmFyIGNscyA9IHJlcXVpcmUoY29udHJvbFBhdGggKyBjb250cm9sbGVyTmV3KTtcblx0XHRcdGhhbmRsZSA9IG5ldyBjbHNbJ2RlZmF1bHQnXSgpO1xuXHRcdFx0aWYgKExpYnMuaXNCbGFuayhwYXRoU3BsaXRbMl0pKSB7XG5cdFx0XHRcdC8vIHBhdGhTcGxpdFsyXSA9IGRlZmF1bHRGdW5jdGlvbjtcblx0XHRcdFx0bG9nLmluZm8oXCJObyByZXF1ZXN0IGZ1bmN0aW9uIGZvdW5kIGZvciBcIiArIG1ldGhvZCk7XG5cdFx0XHRcdHJlc3Aud3JpdGVIZWFkKDQwNCwge1xuXHRcdFx0XHRcdFwiQ29udGVudC1UeXBlXCI6IFwidGV4dC9wbGFpblwiXG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRyZXNwLndyaXRlKFwiNDA0IHJlcXVlc3QgaGFuZGxlciBOb3QgZm91bmRcIik7XG5cdFx0XHRcdHJlc3AuZW5kKCk7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblx0XHRcdHZhciBtZXRob2QgPSBwYXRoU3BsaXRbMl07XG5cdFx0XHQvLyB2YXIgbWV0aG9kID0gYWN0aW9uO1xuXHRcdFx0aGFuZGxlUmVxdWVzdChyZXEsIHJlc3AsIGhhbmRsZSwgbWV0aG9kKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0bG9nLmluZm8oXCJObyByZXF1ZXN0IGZpbGUgZm91bmQgZm9yIFwiICsgcGF0aG5hbWUpO1xuXHRcdFx0cmVzcC53cml0ZUhlYWQoNDA0LCB7XG5cdFx0XHRcdFwiQ29udGVudC1UeXBlXCI6IFwidGV4dC9wbGFpblwiXG5cdFx0XHR9KTtcblx0XHRcdHJlc3Aud3JpdGUoXCI0MDQgcmVxdWVzdCBoYW5kbGVyIE5vdCBmb3VuZFwiKTtcblx0XHRcdHJlc3AuZW5kKCk7XG5cdFx0fVxuXHR9XG59XG5cbnJvdXRlLmNoZWNrUGF0aFJlZmVyZXIgPSAocmVxKSA9Pntcblx0dHJ5e1xuXHRcdGxldCByZXFfcGF0aCA9IHJlcS5oZWFkZXJzWydyZXEtcGF0aCddO1xuXHRcdGxldCByZWZlcmVyID0gZmFsc2U7XG5cdFx0bGV0IHBhdGhSZWZlcmVyID0gZmFsc2U7XG5cdFx0aWYocmVxX3BhdGgpe1xuXHRcdFx0cmVmZXJlciA9IHJlcV9wYXRoXG5cdFx0fWVsc2V7XG5cdFx0XHRyZWZlcmVyID0gcmVxLmhlYWRlcnMucmVmZXJlclxuXHRcdH1cblx0XHRpZihyZWZlcmVyKXtcblx0XHRcdHBhdGhSZWZlcmVyID0gdXJsLnBhcnNlKHJlZmVyZXIsIGZhbHNlKS5wYXRobmFtZTtcblx0XHR9XG5cdFx0cmV0dXJuIHBhdGhSZWZlcmVyO1xuXHR9Y2F0Y2goZXgpe1xuXHRcdGNvbnNvbGUubG9nKFwiY2hlY2tQYXRoUmVmZXJlciBlcnJvcjpcIiwgZXgpO1xuXHRcdHJldHVybiBudWxsO1xuXHR9XG5cdFxufVxuZXhwb3J0cy5yb3V0ZSA9IHJvdXRlOyJdfQ==